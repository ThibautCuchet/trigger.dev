---
title: "Generate a thumbnail from a video using FFmpeg"
sidebarTitle: "FFmpeg thumbnail from video"
description: "This example shows you how to generate a thumbnail from a video using FFmpeg with Trigger.dev and upload the thumbnail to R2 storage."
---

## Overview

This task demonstrates how to use FFmpeg to generate a thumbnail from a video at a specific time and upload the generated thumbnail to R2 storage using Trigger.dev.

## Key Features:

- Fetches a video from a given URL
- Generates a thumbnail from the video at the 5-second mark
- Uploads the generated thumbnail to R2 storage

### Extension configuration

To use our FFmpeg extension during the build process, you need to add it to your project configuration like this:

```ts trigger.config.ts
import { ffmpeg } from "@trigger.dev/build/extensions/core";
import { defineConfig } from "@trigger.dev/sdk/v3";

export default defineConfig({
  project: "<your-project-id>",

...
// Your other config settings...
...

  build: {
    extensions: [
      ffmpeg(),
    ],
  },
});
```

## Task code

```ts trigger/ffmpeg-generate-thumbnail.ts
import { PutObjectCommand, S3Client } from "@aws-sdk/client-s3";
import { logger, task } from "@trigger.dev/sdk/v3";
import ffmpeg from "fluent-ffmpeg";
import fs from "fs/promises";
import fetch from "node-fetch";
import { Readable } from "node:stream";
import os from "os";
import path from "path";

// Initialize S3 client for R2 storage
const s3Client = new S3Client({
  region: "auto",
  endpoint: process.env.S3_ENDPOINT,
  credentials: {
    accessKeyId: process.env.R2_ACCESS_KEY_ID ?? "",
    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY ?? "",
  },
});

export const ffmpegGenerateThumbnail = task({
  id: "ffmpeg-generate-thumbnail",
  run: async (payload: { videoUrl: string }) => {
    const { videoUrl } = payload;

    // Generate output file name with a timestamp
    const tempDirectory = os.tmpdir();
    const outputPath = path.join(tempDirectory, `thumbnail_${Date.now()}.jpg`);

    // Fetch the video from the provided URL
    const response = await fetch(videoUrl);

    // Generate the thumbnail using FFmpeg
    await new Promise((resolve, reject) => {
      if (!response.body) {
        return reject(new Error("Failed to fetch video"));
      }
      ffmpeg(Readable.from(response.body))
        .screenshots({
          count: 1,
          folder: "/tmp",
          filename: path.basename(outputPath),
          size: "320x240",
          timemarks: ["5"], // 5 seconds
        })
        .on("end", resolve)
        .on("error", reject);
    });

    // Read the generated thumbnail into a buffer
    const thumbnail = await fs.readFile(outputPath);

    // Generate the S3 key for the uploaded thumbnail file
    const s3Key = `thumbnails/${path.basename(outputPath)}`;

    // Set up the parameters for uploading the thumbnail to R2
    const uploadParams = {
      Bucket: process.env.S3_BUCKET,
      Key: s3Key,
      Body: thumbnail,
    };

    // Upload the thumbnail to R2 and get the public URL
    await s3Client.send(new PutObjectCommand(uploadParams));
    const s3Url = `https://${process.env.S3_BUCKET}.s3.amazonaws.com/${s3Key}`;
    logger.log("Thumbnail uploaded to R2", { url: s3Url });

    // Delete the temporary thumbnail file
    await fs.unlink(outputPath);

    // Log thumbnail generation results for debugging purposes
    logger.log(`Thumbnail uploaded to S3: ${s3Url}`);

    // Return the thumbnail buffer, file path, and R2 URL
    return {
      thumbnailBuffer: thumbnail,
      thumbnailPath: outputPath,
      s3Url,
    };
  },
});
```
